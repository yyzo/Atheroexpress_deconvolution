---
title: "Deconvolution Scaden"
author: "Yayuan Zhu"
date: "2024-01-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Creating pseudo bulk mixtures for training of the algorithm and performing the deconvolution.

### Setup

```{r message=FALSE, warning=FALSE}
library(magrittr)
library(tidyverse)

source("functions/functions_R.R")
```

## Deconvolution with Scaden

```{python}
import scaden

from scaden.train import training
from scaden.predict import prediction
from scaden.process import processing
from scaden.simulate import simulation

for i in range(1):
  simulation(sample_size = 100, num_samples = 1500, pattern = "*_counts.txt", unknown_celltypes = "unknown", out_prefix = "data", fmt = "txt", data_dir = "output/scaden_plaque/format_files/", simulate_dir = "output/scaden_plaque/simulated_data/")

```

```{bash}
set -e

#Paths
dirPathFiles="output/scaden_plaque/format_files/"
dirPathSimul="output/scaden_plaque/simulated_data/"
dirPathModel="output/scaden_plaque/trained_models/"
dirPathPred="output/scaden_plaque/predictions/"

#Run Scaden 
for i in {1..2}
do
  scaden simulate -n 10 --pattern "*_counts.txt" --data ${dirPathFiles} --out ${dirPathSimul}
done
```

```{bash}
source functions/functions_bash.sh

  scaden process ${dirPathSimul}"/scaden.h5ad" "output/scaden_format_files/scaden_bulk_data_${patientType}.txt" --processed_path ${dirPathSimul}"/processed.h5ad"

  scaden train ${dirPathSimul}"/processed.h5ad" --steps 5000 --model_dir ${dirPathModel}

  scaden predict --model_dir ${dirPathModel} "output/scaden_format_files/scaden_bulk_data_${patientType}.txt" --outname "predictions_plaque_${patientType}_c${ct}_${i}"

  mv "predictions_plaque_${patientType}_c${ct}_${i}" ${dirPathPred}
  
```

```{bash}
scaden simulate --help
```

## Plotting predictions

### All patients

Obtain average proportions:

```{r}
nSimulations = seq(30)

for(i in nSimulations){
  path <- paste0("output/scaden_plaque/predictions/predictions_plaque_b1500_c7_", i)
  file <- paste0("pred", i)
  
  assign(file, read.delim(path,
                          check.names = FALSE))
  assign(file, get(file)[, order(colnames(get(file)))])
  assign(file, `colnames<-`(get(file), c("Patient", colnames(get(file))[-1])))
  
  longFile <- paste0("longPred", i)
  
  assign(longFile, get(file) %>%
           pivot_longer(
             cols = -Patient,
             names_to = "Celltype",
             values_to = "Proportion"))
}

avgProp <- as.data.frame(longPred1[1:2])

for(n in nSimulations){
  avgProp <- left_join(avgProp, 
                       get(paste0("longPred", i)), 
                       by = c("Patient", "Celltype"))
}

avgProp$`Average proportion` <- rowMeans(avgProp[, 3:ncol(avgProp)])
avgProp <- select(avgProp, Patient, Celltype, `Average proportion`)
```

Graphs of all the predictions and average prediction:

```{r}
#All predictions
pdf("output/scaden_plaque/predictions/scaden_plaque_predictions_graphs_all.pdf")

for(k in nSimulations){
  longFile <- paste0("longPred", k)
  p <- ggplot(get(longFile), aes(x = Celltype, y = Proportion)) +
    geom_boxplot() +
    labs(title = "Scaden plaque predictions",
         subtitle = paste0("Run:", k)) +
    theme(axis.text.x = element_text(angle=60, vjust = 1, hjust = 1, size = 8)) +
    scale_y_continuous(name = "Average cell type proportion",
                       limits = c(0, 0.8))
  print(p)
}

dev.off()

#Average prediction
tiff("output/figures/scaden_plaque_average_all.tiff",
     width = 720,
     height = 720,
     units = "px")

pAvg <- ggplot(avgProp, aes(x = Celltype, y = `Average proportion`)) +
  geom_boxplot(fill = "#98CAE1") +
  labs(title = "Scaden plaque predictions",
       subtitle = "All patients") +
  scale_y_continuous(name = "Average cell type proportion",
                           limits = c(0, 0.8)) +
  ownMinimalTheme()

print(pAvg)

dev.off()

```

### Different patient characteristics

From the cellular deconvolution done on all the patients, patients will be subsetted from the obtained predictions based on specific symptoms.

```{r}
patientData <- haven::read_sav("input/AEdata03082023.sav") 

patientData$STUDY_NUMBER <- gsub("^", "ae", patientData$STUDY_NUMBER)

patientData["Symptoms.2g"] <- case_when(patientData$Symptoms.4g == 0 | patientData$Symptoms.4g == 1~"mild",
                                        patientData$Symptoms.4g == 2 | patientData$Symptoms.4g == 3~"severe")

patientData["Symptoms.4g"] <- case_when(patientData$Symptoms.4g == 0~"asymptomatic",
                                        patientData$Symptoms.4g == 1~"ocular",
                                        patientData$Symptoms.4g == 2~"TIA",
                                        patientData$Symptoms.4g == 3~"stroke")

allPatients <- patientData %>%
  filter(STUDY_NUMBER %in% avgProp$Patient) %>%
  select(STUDY_NUMBER, Symptoms.4g, Symptoms.2g) %>%
  rename(Patient = STUDY_NUMBER) %>%
  na.omit()

avgProp2g <- matchSymptomGroup(allPatients, avgProp, "Symptoms.2g", c("mild", "severe")) %>%
  bind_rows()

avgProp4g <- matchSymptomGroup(allPatients, avgProp, "Symptoms.4g", c("asymptomatic", "ocular", "TIA", "stroke")) %>%
  bind_rows()

avgProp4g$Symptoms.4g <- factor(avgProp4g$Symptoms.4g, levels = c("asymptomatic", "ocular", "TIA", "stroke"))

avgPropSymp <- avgProp2g %>%
  left_join(avgProp4g, by = c("Patient", "Celltype", "Average proportion"))
```

#### Mild versus severe symptoms

```{r}
tiff(paste0("output/figures/scaden_plaque_sympt2g.tiff"),
     width = 720,
     height = 720,
     units = "px")

pAvg2g <- ggplot(avgPropSymp, aes(x = Celltype, y = `Average proportion`, fill = Symptoms.2g)) +
  geom_boxplot() +
  labs(title = "Scaden plaque predictions",
       subtitle = "Mild versus severe symptoms",
       fill = "Group") +
  scale_fill_manual(values = c("#8ec3de", "#f6a582")) +
  scale_color_manual(values = c("black", "black")) +
  scale_y_continuous(name = "Average cell type proportion",
                     limits = c(0, 0.8)) +
  ownMinimalTheme()

print(pAvg2g)

dev.off()
```

#### Asymptomatic versus ocular versus TIA versus stroke symptoms

```{r}
tiff(paste0("output/figures/scaden_plaque_sympt4g.tiff"),
     width = 720,
     height = 720,
     units = "px")

pAvg4g <- ggplot(avgPropSymp, aes(x = Celltype, y = `Average proportion`, fill = Symptoms.4g)) +
  geom_boxplot() +
  labs(title = "Scaden plaque predictions",
       subtitle = "Asymptomatic versus ocular versus TIA versus stroke",
       fill = "Group") +
  scale_fill_manual(values = c("#1065ab", "#8ec3de", "#f6a582", "#b31529")) +
  scale_color_manual(values = c("black", "black", "black","black")) +
  scale_y_continuous(name = "Average cell type proportion",
                           limits = c(0, 0.8)) +
  ownMinimalTheme()

print(pAvg4g)

dev.off()
```

## Statistical tests

### Mild versus severe symptoms

```{r}
boxplotPlot <- ggplot(avgPropMildSevere, aes(x = Group, y = `Average proportion`, fill = Group)) +
  geom_boxplot() +
  labs(x = "Group", y = "Cellular Proportions")

histPlot <- avgPropMildSevere %>%
  ggplot(aes(x = `Average proportion`, fill = Group)) +
  geom_histogram(binwidth = 0.1, position = "identity", alpha = 0.7) +
  facet_wrap(~Group) +
  labs(x = "Cellular Proportions", y = "Frequency")

qqPlot <- ggqqplot(avgPropMildSevere, x = "Average proportion") +
  labs(x = "Theoretical Quantiles", y = "Sample Quantiles")

print(boxplotPlot)
print(histPlot)
print(qqPlot)

#Test for normality
shapiro_res <- avgPropMildSevere %>%
  group_by(Group) %>%
  summarise(p_value = shapiro.test(`Average proportion`)$p.value)

print(shapiro_res)

#Test for equality of variances
levene_res <- var.test(`Average proportion` ~ Group, data = avgPropMildSevere)

print(levene_res)

mwu_res <- wilcox.test(`Average proportion` ~ Group, data = avgPropMildSevere)
print(mwu_res)
```

## Plotting predictions - Gemma

### All patients

```{r}
#17 patients here are not present in own predictions.
gemmaProp <- subset(read_csv("input/Gemmaprops8clustersAE.csv"), Algorithm == "Scaden")

gemmaFinalProp <- gemmaProp %>%
  mutate(`Endothelial cell` = rowMeans(select(., `Endothelial Cells I`, `Endothelial Cells II`))) %>%
  select(-`Endothelial Cells I`, -`Endothelial Cells II`, -Algorithm) %>%
  select(1, order(colnames(.))) %>%
  pivot_longer(
    cols = -Patient,
    names_to = "Celltype",
    values_to = "Average proportion"
  )

tiff("output/figures/Gemma_plaque_all.tiff",
     width = 720,
     height = 720,
     units = "px")

pGemma <- ggplot(gemmaFinalProp, aes(x = Celltype, y = `Average proportion`)) +
  geom_boxplot(fill = "#98CAE1") +
  labs(title = "Gemma plaque predictions",
       subtitle = "All patients") +
  scale_y_continuous(name = "Average cell type proportion",
                     limits = c(0, 0.8)) +
  ownMinimalTheme()

print(pGemma)

dev.off()
```

### Different patient characteristics

```{r}
gemmaPatients <- patientData %>%
  filter(STUDY_NUMBER %in% gemmaFinalProp$Patient) %>%
  select(STUDY_NUMBER, Symptoms.4g, Symptoms.2g) %>%
  rename(Patient = STUDY_NUMBER) %>%
  na.omit()

gemmaProp2g <- matchSymptomGroup(gemmaPatients, gemmaFinalProp, "Symptoms.2g", c("mild", "severe")) %>%
  bind_rows()

gemmaProp4g <- matchSymptomGroup(gemmaPatients, gemmaFinalProp, "Symptoms.4g", c("asymptomatic", "ocular", "TIA", "stroke")) %>%
  bind_rows()

gemmaProp4g$Symptoms.4g <- factor(gemmaProp4g$Symptoms.4g, levels = c("asymptomatic", "ocular", "TIA", "stroke"))

gemmaPropSymp <- gemmaProp2g %>%
  left_join(gemmaProp4g, by = c("Patient", "Celltype", "Average proportion"))
  
```

#### Mild versus severe

```{r}
tiff(paste0("output/figures/gemma_plaque_sympt2g.tiff"),
     width = 720,
     height = 720,
     units = "px")

pGemma2g <- ggplot(gemmaPropSymp, aes(x = Celltype, y = `Average proportion`, fill = Symptoms.2g)) +
  geom_boxplot() +
  labs(title = "Gemma plaque predictions",
       subtitle = "Mild versus severe symptoms",
       fill = "Group") +
  scale_fill_manual(values = c("#8ec3de", "#f6a582")) +
  scale_color_manual(values = c("black", "black")) +
  scale_y_continuous(name = "Average cell type proportion",
                     limits = c(0, 0.8)) +
  ownMinimalTheme()

print(pGemma2g)

dev.off()
```

#### Asymptomatic versus ocular versus TIA versus stroke

```{r}
tiff(paste0("output/figures/gemma_plaque_sympt4g.tiff"),
     width = 720,
     height = 720,
     units = "px")

pGemma4g <- ggplot(gemmaPropSymp, aes(x = Celltype, y = `Average proportion`, fill = Symptoms.4g)) +
  geom_boxplot() +
  labs(title = "Gemma plaque predictions",
       subtitle = "Asymptomatic versus ocular versus TIA versus stroke",
       fill = "Group") +
  scale_fill_manual(values = c("#1065ab", "#8ec3de", "#f6a582", "#b31529")) +
  scale_color_manual(values = c("black", "black", "black","black")) +
  scale_y_continuous(name = "Average cell type proportion",
                           limits = c(0, 0.8)) +
  ownMinimalTheme()

print(pGemma4g)

dev.off()
```

## Correlation plots - predictions own versus Gemma

```{r}
filterGemmaPropSymp <- filter(gemmaPropSymp, Patient %in% avgPropSymp$Patient)

#Mild
own <- filter(avgPropSymp, Symptoms.2g == "mild")
gemma <- filter(filterGemmaPropSymp, Symptoms.2g == "mild")
compare <- own[1:2]
compare["ownProp"] <- own$`Average proportion`
compare["gemmaProp"] <- gemma$`Average proportion`

tiff("output/figures/cor_plaque_mild.tiff",
     width = 720,
     height = 720,
     units = "px")

ggplot(compare, aes(x = ownProp, y = gemmaProp)) +
  geom_point() +
  geom_smooth(method = lm) +
  facet_wrap(~ Celltype, nrow = 3, scales = "free") +
  labs(title = "Correlation average cellular proportions of Sympt2g_mild")

dev.off()

#Severe
own <- filter(avgPropSymp, Symptoms.2g == "severe")
gemma <- filter(filterGemmaPropSymp, Symptoms.2g == "severe")
compare <- own[1:2]
compare["ownProp"] <- own$`Average proportion`
compare["gemmaProp"] <- gemma$`Average proportion`

tiff("output/figures/cor_plaque_severe.tiff",
     width = 720,
     height = 720,
     units = "px")

ggplot(compare, aes(x = ownProp, y = gemmaProp)) +
  geom_point() +
  geom_smooth(method = lm) +
  facet_wrap(~ Celltype, nrow = 3, scales = "free") +
  labs(title = "Correlation average cellular proportions of Sympt2g_severe")

dev.off()

#Asymptomatic
own <- filter(avgPropSymp, Symptoms.4g == "asymptomatic")
gemma <- filter(filterGemmaPropSymp, Symptoms.4g == "asymptomatic")
compare <- own[1:2]
compare["ownProp"] <- own$`Average proportion`
compare["gemmaProp"] <- gemma$`Average proportion`

tiff("output/figures/cor_plaque_asymptomatic.tiff",
     width = 720,
     height = 720,
     units = "px")

ggplot(compare, aes(x = ownProp, y = gemmaProp)) +
  geom_point() +
  geom_smooth(method = lm) +
  facet_wrap(~ Celltype, nrow = 3, scales = "free") +
  labs(title = "Correlation average cellular proportions of Sympt4g_asymptomatic")

dev.off()

#Ocular
own <- filter(avgPropSymp, Symptoms.4g == "ocular")
gemma <- filter(filterGemmaPropSymp, Symptoms.4g == "ocular")
compare <- own[1:2]
compare["ownProp"] <- own$`Average proportion`
compare["gemmaProp"] <- gemma$`Average proportion`

tiff("output/figures/cor_plaque_ocular.tiff",
     width = 720,
     height = 720,
     units = "px")

ggplot(compare, aes(x = ownProp, y = gemmaProp)) +
  geom_point() +
  geom_smooth(method = lm) +
  facet_wrap(~ Celltype, nrow = 3, scales = "free") +
  labs(title = "Correlation average cellular proportions of Sympt4g_ocular")

dev.off()

#TIA
own <- filter(avgPropSymp, Symptoms.4g == "TIA")
gemma <- filter(filterGemmaPropSymp, Symptoms.4g == "TIA")
compare <- own[1:2]
compare["ownProp"] <- own$`Average proportion`
compare["gemmaProp"] <- gemma$`Average proportion`

test <- filter(own, ! (own$Patient %in% gemma$Patient))

tiff("output/figures/cor_plaque_TIA.tiff",
     width = 720,
     height = 720,
     units = "px")

ggplot(compare, aes(x = ownProp, y = gemmaProp)) +
  geom_point() +
  geom_smooth(method = lm) +
  facet_wrap(~ Celltype, nrow = 3, scales = "free") +
  labs(title = "Correlation average cellular proportions of Sympt4g_TIA")

dev.off()

#Stroke
own <- filter(avgPropSymp, Symptoms.4g == "stroke")
gemma <- filter(filterGemmaPropSymp, Symptoms.4g == "stroke")
compare <- own[1:2]
compare["ownProp"] <- own$`Average proportion`
compare["gemmaProp"] <- gemma$`Average proportion`

tiff("output/figures/cor_plaque_stroke.tiff",
     width = 720,
     height = 720,
     units = "px")

ggplot(compare, aes(x = ownProp, y = gemmaProp)) +
  geom_point() +
  geom_smooth(method = lm) +
  facet_wrap(~ Celltype, nrow = 3, scales = "free") +
  labs(title = "Correlation average cellular proportions of Sympt4g_stroke")

dev.off()
```

## Session info

```{r}
devtools::session_info()
```
