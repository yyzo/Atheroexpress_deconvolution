---
title: "Deconvolution Scaden"
author: "Yayuan Zhu"
date: "2024-01-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Creating pseudo bulk mixtures for training of the algorithm and performing the deconvolution.

### Setup

```{r message=FALSE, warning=FALSE}
library(magrittr)
library(tidyverse)
```

## Deconvolution with Scaden

### Example datasets

```{r}
exampleBulk <- read.table("example_data/example_bulk_data.txt")
exampleCellTypes <- read.table("example_data/example_celltypes.txt")
exampleCounts <- read.table("example_data/example_counts.txt")
```

scaden simulate --data C:/Users/YaYua/R_projects/Atheroexpress_deconvolution/example_data -n 100 --pattern "\*\_counts.txt"

```{bash}
scaden example --out example_data/

scaden simulate --data example_data/ -n 100 --pattern "*_counts.txt"

scaden process data.h5ad example_data/example_bulk_data.txt

scaden train processed.h5ad --steps 5000 --model_dir model #Roughly 10 minutes.

scaden predict --model_dir model example_data/example_bulk_data.txt
```

### AtheroExpress data (rownames excluded)

#### #1

```{bash}
scaden simulate --data output/scaden_format_files/ -n 100 --pattern "*_counts.txt" --out output/scaden_b100_s5000_v1

scaden process output/scaden_b100_s5000_v1/scaden.h5ad output/scaden_format_files/scaden_bulk_data.txt --processed_path output/scaden_b100_s5000_v1/processed.h5ad

scaden train output/scaden_b100_s5000_v1/processed.h5ad --steps 5000 --model_dir models/model_b100_s5000_v1

scaden predict --model_dir models/model_b100_s5000_v1 output/scaden_format_files/scaden_bulk_data.txt
```

#### #4: explicitly rename rownames, starting from 1

```{bash}
scaden simulate --data output/scaden_one/ -n 700 --pattern "*_counts.txt" --out output/scaden_one

scaden process output/scaden_one/scaden.h5ad output/scaden_one/scaden_bulk_data.txt --processed_path output/scaden_one/processed.h5ad

scaden train output/scaden_one/processed.h5ad --steps 5000 --model_dir models/model_one

scaden predict --model_dir models/model_one output/scaden_one/scaden_bulk_data.txt
```

#### Making it iterative

**PROCESSED_PATH COMMAND NOT FOUND, DOWNGRADE PYTHON AGAIN?**

```{bash}
for i in {1..3}
do
  mkdir output/plaque_b700_$i
  mkdir models/model_plaque_b700_$i
  
  scaden simulate --data output/scaden_format_files/ -n 20 --pattern "*_counts.txt" --out output/plaque_b700_$i
  
  scaden process output/plaque_b700_$i/scaden.h5ad output/scaden_format_files/scaden_bulk_data.txt
  --processed_path output/plaque_b700_$i/processed.h5ad
  
  scaden train output/plaque_b700_$i/processed.h5ad --steps 1 --model_dir models/model_plaque_b700_$i
  
  scaden predict --model_dir models/model_plaque_b700_$i output/scaden_format_files/scaden_bulk_data.txt --outname predictions_plaque_b700_$i
done
```

## Plotting predictions

### Example prediction

```{r}
examplePrediction <- read.table("example_data/example_predictions.txt")

longExample <- examplePrediction %>%
  rownames_to_column("Sample") %>%
  pivot_longer(
             cols = -Sample,
             names_to = "Celltype",
             values_to = "Proportion"
  )

ggplot(longExample, aes(x = Celltype, y = Proportion)) +
  geom_boxplot()
```

### AtheroExpress data (rownames excluded)

```{r}
scadenBulk <- read.delim("output/scaden_format_files/scaden_bulk_data.txt")
scadenCounts <- read.delim("output/scaden_format_files/scaden_counts.txt")
scadenCellTypes <- read.delim("output/scaden_format_files/scaden_celltypes.txt")

View(as.data.frame(head(scadenCounts)))

scadenPred1 <- read.delim("scaden_predictions.txt", check.names = FALSE)
colnames(scadenPred1)[1] = "Patient"

cellTypes <- colnames(scadenPred1)[2:ncol(scadenPred1)]

newNames <- as.vector(c("Class-switched Memory B Cells",
                        "Smooth Muscle Cells",
                        "Endothelial Cells",
                        "FOXP3+ T Cells",
                        "CD56- NK Cells",
                        "CD56+ NK Cells",
                        "Proliferating T Cells",
                        "Resident-like Macrophages",
                        "CD4+ T Cells",
                        "Lipid Associated Macrophages",
                        "Inflammatory Lipid Associated Macrophages",
                        "CD8+ T Cells",
                        "Inflammatory Foamy Macrophages",
                        "cDC2",
                        "Inflammatory Monocyte-derived Macrophages",
                        "Foamy Macrophages",
                        "S100A8+ Migrating Monocyte-derived Macrophages",
                        "Antigen-presenting Monocyte-derived Macrophages",
                        "cDC1",
                        "Mast Cells",
                        "CD16+ Migrating Monocyte-derived Macrophages"))

renamedCellTypes <- as.data.frame(cbind(cellTypes, newNames))

colnames(scadenPred1)[2:ncol(scadenPred1)] <- newNames

longScadenPred1 <- scadenPred1 %>%
  pivot_longer(
    cols = -Patient,
    names_to = "Celltype",
    values_to = "Proportion"
  )

ggplot(longScadenPred1, aes(x = Celltype, y = Proportion)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle=60, vjust = 1, hjust = 1, size = 8))
```

### Iterative

```{r}
for (i in 1:10){
  print(i)
}

for(i in 1:10){
  filePath <- paste("output/plaque_b700_", i, "/predictions_plaque_b700_", i, ".txt", sep = "")
  fileName <- paste("predictions", i, sep = "")
  
  fileName <- read.delim(file_path)
  colnames(fileName)[1] = "Patient"
}

cellTypes <- colnames(fileName)[2:ncol(fileName)]

newNames <- as.vector(c("Class-switched Memory B Cells",
                        "Smooth Muscle Cells",
                        "Endothelial Cells",
                        "FOXP3+ T Cells",
                        "CD56- NK Cells",
                        "CD56+ NK Cells",
                        "Proliferating T Cells",
                        "Resident-like Macrophages",
                        "CD4+ T Cells",
                        "Lipid Associated Macrophages",
                        "Inflammatory Lipid Associated Macrophages",
                        "CD8+ T Cells",
                        "Inflammatory Foamy Macrophages",
                        "cDC2",
                        "Inflammatory Monocyte-derived Macrophages",
                        "Foamy Macrophages",
                        "S100A8+ Migrating Monocyte-derived Macrophages",
                        "Antigen-presenting Monocyte-derived Macrophages",
                        "cDC1",
                        "Mast Cells",
                        "CD16+ Migrating Monocyte-derived Macrophages"))

renamedCellTypes <- as.data.frame(cbind(cellTypes, newNames))

for(i in 1:10){
  fileName <- paste("predictions", i, sep = "")
  
  colnames(fileName)[2:ncol(fileName)] <- newNames
  
  longName <- paste("longPredictions", i)
  
  longName <- fileName %>%
    pivot_longer(
      cols = -Patient,
      names_to = "Celltype",
      values_to = "Cell type proportion"
    )
  
  ggplot(longName, aes(x = Celltype, y = Proportion)) +
    geom_boxplot() +
    theme(axis.text.x = element_text(angle=60, vjust = 1, hjust = 1, size = 8))
  
  ggsave(paste(fileName, ".png", sep = ""))
  
}
```

## Session info

```{r}
devtools::session_info()
```
