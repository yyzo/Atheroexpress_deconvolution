---
title: "Deconvolution Scaden"
author: "Yayuan Zhu"
date: "2024-01-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Creating pseudo bulk mixtures for training of the algorithm and performing the deconvolution.

### Setup

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(magrittr)

source("functions/functions_R.R")
```

## Checking Scaden input files

```{r}
scadenBulk <- read.delim("output/scaden_plaque/format_files/scaden_bulk_data.txt")
scadenCounts <- read.delim("output/scaden_plaque/format_files/scaden_counts.txt")
scadenCellTypes <- read.delim("output/scaden_plaque/format_files/scaden_celltypes.txt")


neutBulk <- read.delim("output/scaden_neutrophils/format_files/scadenNeutrophil_bulk_data.txt")
neutCounts <- read.delim("output/scaden_neutrophils/format_files/scadenNeutrophil_counts.txt")
neutCellTypes <- read.delim("output/scaden_neutrophils/format_files/scadenNeutrophil_celltypes.txt")

ctBulk <- read.delim("output/scaden_ctRNA/format_files/scadenCtRNA_bulk_data.txt")
ctCounts <- read.delim("output/scaden_ctRNA/format_files/scadenCtRNA_counts.txt")
ctCellTypes <- read.delim("output/scaden_ctRNA/format_files/scadenCtRNA_celltypes.txt")
```

## Deconvolution with Scaden - example data

```{bash}
mkdir example_data
scaden example --out example_data/
```

```{bash}
scaden simulate --data example_data/ -n 100 --pattern "*_counts.txt"

scaden process data.h5ad example_data/example_bulk_data.txt

scaden train processed.h5ad --steps 50 --model_dir model

scaden predict --model_dir model example_data/example_bulk_data.txt
```

```{bash}
source functions/functions_bash.sh
set -e

typeDeconv="example" # Main folder
pattern="example" # Pattern of input files as recognized by Scaden

dirPathFiles="output/$typeDeconv/format_files"
dirPathSimul="output/$typeDeconv/simulated_data"
dirPathModel="output/$typeDeconv/trained_models"
dirPathPred="output/$typeDeconv/predictions"

for i in {1..10}
do
  scaden simulate -n 1000 --pattern "*_counts.txt" --data $dirPathFiles --out $dirPathSimul
  
    scaden process "${dirPathSimul}/${pattern}.h5ad" "${dirPathFiles}/${pattern}_bulk_data.txt" --processed_path "${dirPathSimul}/processed.h5ad"

  scaden train "${dirPathSimul}/processed.h5ad" --steps 5000 --model_dir $dirPathModel

  scaden predict --model_dir " ${dirPathModel}" "${dirPathFiles}/${pattern}_bulk_data.txt" --outname "predictions_${typeDeconv}_${i}"

  mv "predictions_${typeDeconv}_${i}" $dirPathPred
  
  echo "Moved predictions_${typeDeconv}_${i} to $dirPathPred"
  
  emptyDir $dirPathSimul $i
  
  emptyDir $dirPathModel $i
done
```

## Deconvolution with Scaden

### Only one scRNA-seq reference

```{bash}
source functions/functions_bash.sh
set -e

typeDeconv="scaden_plaque" # Main folder
pattern="scaden" # Pattern of input files as recognized by Scaden
celltypes="7" # Number of cell types in scRNA-seq reference

dirPathFiles="output/${typeDeconv}/format_files"
dirPathSimul="output/${typeDeconv}/simulated_data"
dirPathModel="output/${typeDeconv}/trained_models"
dirPathPred="output/${typeDeconv}/predictions"

# Setting both start and end to the same number will only run the loop once
start=1
end=10

for i in $(seq $start $end)
do
  scaden simulate -n 1000 --pattern "*_counts.txt" --data $dirPathFiles --out $dirPathSimul
  
    scaden process "${dirPathSimul}/${pattern}.h5ad" "${dirPathFiles}/${pattern}_bulk_data.txt" --processed_path "${dirPathSimul}/processed.h5ad"

  scaden train "${dirPathSimul}/processed.h5ad" --steps 5000 --model_dir $dirPathModel

  scaden predict --model_dir $dirPathModel "${dirPathFiles}/${pattern}_bulk_data.txt" --outname "predictions_${typeDeconv}_c${celltypes}_${i}"

  mv "predictions_${typeDeconv}_c${celltypes}_${i}" $dirPathPred
  
  echo "Moved predictions_${typeDeconv}_c${celltypes}_${i} to ${dirPathPred}"
  
  emptyDir $dirPathSimul $i
  
  emptyDir $dirPathModel $i
done
```

### Multiple types of reference files

```{bash}
source functions/functions_bash.sh
set -e

typeDeconv="scaden_cfRNA" # Main folder
patternRef="scaden_cfRNA_c14_v3" # Pattern of input files as recognized by Scaden of the reference files
patternBulk="scaden_plaque_for_cfRNA" # Pattern of bulk RNA-seq input file as recognized by Scaden

dirPathFiles="output/${typeDeconv}/format_files"
dirPathCount="${dirPathFiles}/${patternRef}"
dirPathSimul="output/${typeDeconv}/simulated_data"
dirPathModel="output/${typeDeconv}/trained_models"
dirPathPred="output/${typeDeconv}/predictions"

# Setting both start and end to the same number will only run the loop once
start=2
end=10

for i in $(seq $start $end)
do
  scaden simulate -n 1000 --pattern "*_counts.txt" --data $dirPathCount --out $dirPathSimul
  
  scaden process "${dirPathSimul}/${patternRef}.h5ad" "${dirPathFiles}/${patternBulk}_bulk_data.txt" --processed_path "${dirPathSimul}/processed.h5ad"

  scaden train "${dirPathSimul}/processed.h5ad" --steps 5000 --model_dir $dirPathModel

  scaden predict --model_dir $dirPathModel "${dirPathFiles}/${patternBulk}_bulk_data.txt" --outname "predictions_${patternRef}_n${i}"

  mv "predictions_${patternRef}_n${i}" $dirPathPred
  
  echo "Moved predictions_${patternRef}_n${i} to ${dirPathPred}"
  
  emptyDir $dirPathSimul $i
  
  emptyDir $dirPathModel $i
done
```

## Session info

```{r}
devtools::session_info()
```
