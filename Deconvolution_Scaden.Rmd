---
title: "Deconvolution Scaden"
author: "Yayuan Zhu"
date: "2024-01-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Creating pseudo bulk mixtures for training of the algorithm and performing the deconvolution.

### Setup

```{r message=FALSE, warning=FALSE}
library(magrittr)
library(tidyverse)
```

## Deconvolution with Scaden

### Example datasets

```{r}
exampleBulk <- read.table("example_data/example_bulk_data.txt")
exampleCellTypes <- read.table("example_data/example_celltypes.txt")
exampleCounts <- read_table("example_data/example_counts.txt")
```

```{bash}
scaden simulate --data example_data/ -n 100 --pattern "*_counts.txt"

scaden process data.h5ad example_data/example_bulk_data.txt --processed_path example_data/processed.h5ad

scaden train processed.h5ad --steps 5000 --model_dir model

scaden predict --model_dir model example_data/example_bulk_data.txt
```

### AtheroExpress data

```{r}
scadenBulk <- read.delim("output/scaden_format_files/scaden_bulk_data.txt")
scadenCellTypes <- read.delim("output/scaden_format_files/scaden_celltypes.txt")
scadenCounts <- read.delim("output/scaden_format_files/scaden_counts.txt")

View(head(scadenCounts)[1:5])
```

```{bash}
source functions/functions_bash.sh
set -e

bk="500" #Number of bulk RNA-seq samples to be simulated.

dirPathOutput="output/scaden_simulations_plaque/scaden_plaque_b$bk/plaque_b${bk}_"
dirPathModel="models/scaden_models_plaque/scaden_models_plaque_b$bk/model_plaque_b${bk}_"
dirPathPred="output/scaden_simulations_plaque/scaden_plaque_b$bk/predictions"

createDir "output/scaden_simulations_plaque/scaden_plaque_b$bk"
createDir "models/scaden_models_plaque/scaden_models_plaque_b$bk"
createDir "output/scaden_simulations_plaque/scaden_plaque_b$bk/predictions"             

for i in {1..15}
do
  mkdir ${dirPathOutput}${i}
  
  scaden simulate --data output/scaden_format_files/ -n $bk --pattern "*_counts.txt" --out ${dirPathOutput}${i}
  
  scaden process ${dirPathOutput}${i}/scaden.h5ad output/scaden_format_files/scaden_bulk_data.txt --processed_path ${dirPathOutput}${i}/processed.h5ad
  
  mkdir ${dirPathModel}${i}
  
  scaden train ${dirPathOutput}${i}/processed.h5ad --steps 5000 --model_dir ${dirPathModel}${i}
  
  scaden predict --model_dir ${dirPathModel}${i} output/scaden_format_files/scaden_bulk_data.txt --outname predictions_plaque_b${bk}_${i}
  
  mv predictions_plaque_b${bk}_${i} ${dirPathPred}
done
```

```{bash}
shutdown now
```

## Plotting predictions

### Example prediction

```{r}
examplePrediction <- read.table("example_data/example_predictions.txt")

longExample <- examplePrediction %>%
  rownames_to_column("Sample") %>%
  pivot_longer(
             cols = -Sample,
             names_to = "Celltype",
             values_to = "Proportion"
  )

ggplot(longExample, aes(x = Celltype, y = Proportion)) +
  geom_boxplot()
```

### Preparing data and plotting figures: separate

```{r}
bk <- "500"

for(i in 1:15){
  path <- paste0("output/scaden_simulations_plaque/scaden_plaque_b", bk, "/predictions/predictions_plaque_b", bk,"_", i)
  file <- paste0("scadenPred", i)
  
  assign(file, read.delim(path,
                         check.names = FALSE))
  assign(file, get(file)[, order(colnames(get(file)))])
  assign(file, `colnames<-`(get(file), c("Patient", colnames(get(file))[-1])))
}

cellTypes <- colnames(scadenPred1)[2:ncol(scadenPred1)]

newNames <- as.vector(c("Smooth Muscle Cells",
                        "CD16+ MIM-derived Macrophages",
                        "Resident-like Macrophages",
                        "AIM-derived Macrophages",
                        "IAIM-derived Macrophages",
                        "S100A8+ MIM-derived Macrophages",
                        "IRLA Macrophages",
                        "Foamy Macrophages",
                        "Inflammatory Foamy Macrophages",
                        "Lipid Associated Macrophages",
                        "cDC1",
                        "Proliferating T cells",
                        "Endothelial cells",
                        "CD4+ T cells",
                        "CD56- NK cells",
                        "CD56+ NK cells",
                        "Memory B Cells",
                        "CD8+ T cells",
                        "cDC2",
                        "FOXP3+ T Cells",
                        "Mast Cells"))

renamedCellTypes <- as.data.frame(cbind(cellTypes, newNames))

for(j in 1:15){
  file <- paste0("scadenPred", j)
  data <- get(file)
  
  colnames(data)[-1] <- newNames
  assign(file, data)
}

for(k in 1:15){
  file <- paste0("scadenPred", k)
  longFile <- paste0("longScadenPred", k)
  
  assign(longFile, get(file) %>%
           pivot_longer(
             cols = -Patient,
             names_to = "Celltype",
             values_to = "Proportion"))
}
```

```{r}
dirPathFigure <- paste0("output/scaden_simulations_plaque/scaden_plaque_b", bk, "/predictions/scaden_plaque_predictions_graphs.pdf")

pdf(file = dirPathFigure)

for(n in 1:15){
  longFile <- paste0("longScadenPred", n)
  p <- ggplot(get(longFile), aes(x = Celltype, y = Proportion)) +
    geom_boxplot() +
    labs(title = "Scaden plaque predictions",
               subtitle = paste0("Bulk simulated:", bk, "\nRun:", n)) +
    theme(axis.text.x = element_text(angle=60, vjust = 1, hjust = 1, size = 8))
  print(p)
}

dev.off()
```

### Preparing data and plotting figures: average

```{r}
#Match patient & celltype
  #Take proportion (and put it in a vector?)
  #Take average of proportions

avgProportions <- as.data.frame(longScadenPred1[1:2])

for(i in 1:15){
  avgProportions <- left_join(avgProportions, get(paste0("longScadenPred", i)), by = c("Patient", "Celltype"))
}

avgProportions$`Average proportion` <- rowMeans(avgProportions[, 3:17])

dirPathFigureAvg <- paste0("output/scaden_simulations_plaque/scaden_plaque_b", bk, "/predictions/scaden_plaque_predictions_graphs_average.pdf")

pdf(file = dirPathFigureAvg)

pAvg <- ggplot(avgProportions, aes(x = Celltype, y = `Average proportion`)) +
  geom_boxplot() +
  labs(title = "Scaden plaque predictions",
               subtitle = paste0("Bulk simulated:", bk)) +
  theme(axis.text.x = element_text(angle=60, vjust = 1, hjust = 1, size = 8))

print(pAvg)

dev.off()

```

## Session info

```{r}
devtools::session_info()
```
